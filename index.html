<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>多科目答題系統</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 14px;
      padding: 10px;
      line-height: 1.6;
      max-width: 600px;
      margin: auto;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .selector-group {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    .subject-selector-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    label, select {
      font-size: 14px;
    }
    select, button {
      padding: 6px 10px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
    }
    .subject-selector-group label, .subject-selector-group select {
        margin: 0;
    }
    .question-box {
      margin-top: 20px;
      font-size: 18px;
      touch-action: pan-y;
      min-height: 200px; /* 增加最小高度，確保有足夠的滑動區域 */
      display: flex; /* 使用 flexbox 讓內容垂直居中，美觀 */
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }
    .option {
      display: block;
      margin: 8px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
      width: 100%; /* 確保選項佔滿寬度 */
      box-sizing: border-box; /* 邊框和內距包含在寬度內 */
    }
    .option.correct {
      background-color: #e2f7e1;
      border-color: #c3e6cb;
    }
    .option.incorrect {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    #result {
      margin-top: 15px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: #fafafa;
      font-size: 18px;
      line-height: 1.7;
      display: none;
    }
    #score {
      margin-top: 5px;
      font-size: 14px;
    }
    .button-group {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    #reset-btn {
        margin-left: auto;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background-color: white;
      padding: 20px 30px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .modal-content h3 {
      margin-top: 0;
    }
    .modal-buttons button {
      margin: 0 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <div class="selector-group">
      <div class="subject-selector-group">
        <label for="subject-select">請選擇科目：</label>
        <select id="subject-select"></select>
      </div>
      <div class="subject-selector-group">
        <label for="question-quantity-select">題目數量：</label>
        <select id="question-quantity-select">
          <option value="10">10題</option>
          <option value="20">20題</option>
          <option value="30">30題</option>
          <option value="50">50題</option>
        </select>
      </div>
    </div>
  </div>

  <div class="question-box" id="question-box"></div>
  <div id="result"></div>
  <div id="score"></div>
  <div class="button-group">
    <button id="prev-btn" disabled>上一題</button>
    <button id="explanation-btn" disabled>看解析</button>
    <button id="next-btn" disabled>下一題</button>
    <button id="calculate-btn" disabled style="display: none;">結算</button>
    <button id="reset-btn">重新開始</button>
  </div>

  <div id="end-quiz-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>測驗結束！</h3>
      <p id="modal-score-summary"></p>
      <div class="modal-buttons">
        <button id="review-wrong-btn">錯題檢討</button>
        <button id="finish-quiz-btn">結束</button>
      </div>
    </div>
  </div>

  <script>
    const subjects = [
        { name: "監獄行刑法", file: "監獄行刑法.json" },
        { name: "刑法", file: "刑法.json" },
        { name: "法學緒論", file: "法學緒論.json" },
        { name: "犯罪學", file: "犯罪學.json" },
        { name: "監獄學", file: "監獄學.json" },
        { name: "模擬試題", file: "模擬試題.json" }
    ];

    let allQuestionsForSubject = []; 
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let scorePoints = 0;
    let completedCount = 0;

    const subjectSelect = document.getElementById("subject-select");
    const questionQuantitySelect = document.getElementById("question-quantity-select");
    const questionBox = document.getElementById("question-box");
    const result = document.getElementById("result");
    const score = document.getElementById("score");
    const nextBtn = document.getElementById("next-btn");
    const prevBtn = document.getElementById("prev-btn");
    const calculateBtn = document.getElementById("calculate-btn");
    const resetBtn = document.getElementById("reset-btn");
    const explanationBtn = document.getElementById("explanation-btn");
    const endQuizModal = document.getElementById("end-quiz-modal");
    const modalScoreSummary = document.getElementById("modal-score-summary");
    const reviewWrongBtn = document.getElementById("review-wrong-btn");
    const finishQuizBtn = document.getElementById("finish-quiz-btn");
    
    // 觸控事件相關變數
    let touchstartX = 0;
    let touchendX = 0;
    const swipeThreshold = 50; // 滑動距離閾值 (像素)

    function setupSubjectSelector() {
        subjectSelect.innerHTML = '';
        subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.name;
            option.textContent = subject.name;
            subjectSelect.appendChild(option);
        });
        
        setupEventListeners(); // 集中設定事件監聽器
        loadSubjectAndStartQuiz();
    }
    
    // 新增：集中設定所有事件監聽器的函數
    function setupEventListeners() {
        subjectSelect.addEventListener("change", loadSubjectAndStartQuiz);
        questionQuantitySelect.addEventListener("change", loadSubjectAndStartQuiz);
        prevBtn.addEventListener("click", previousQuestion); // 從 onclick 移過來
        explanationBtn.addEventListener("click", toggleExplanation); // 從 onclick 移過來
        nextBtn.addEventListener("click", nextQuestion); // 從 onclick 移過來
        calculateBtn.addEventListener("click", showEndQuizModal);
        resetBtn.addEventListener("click", startNewQuiz); // 從 onclick 移過來

        // 觸控事件監聽器
        questionBox.addEventListener('touchstart', e => {
            touchstartX = e.changedTouches[0].screenX;
        }, false);

        questionBox.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            handleGesture();
        }, false);

        reviewWrongBtn.addEventListener('click', () => {
            endQuizModal.style.display = 'none';
            const wrongQuestions = currentQuestions.filter(q => !q.userAttempt.wasCorrect);
            if (wrongQuestions.length === 0) {
                alert("恭喜您，全部答對！沒有錯題可以檢討。");
                startNewQuiz();
                return;
            }
            // 錯題檢討時，直接使用所有錯題，不再次隨機選擇數量
            initializeQuiz(wrongQuestions, true); // 傳遞 true 表示為錯題檢討模式
        });

        finishQuizBtn.addEventListener('click', () => {
            endQuizModal.style.display = 'none';
            startNewQuiz();
        });
    }

    async function loadSubjectAndStartQuiz() {
        const selectedSubject = subjects.find(s => s.name === subjectSelect.value);
        if (!selectedSubject) {
            console.error("找不到對應的科目檔案");
            return;
        }

        try {
            const response = await fetch(selectedSubject.file); 
            if (!response.ok) {
                throw new Error(`無法載入題庫檔案：${selectedSubject.file}`);
            }
            allQuestionsForSubject = await response.json();
            initializeQuiz(allQuestionsForSubject);

        } catch (error) {
            console.error("載入題庫失敗:", error); // 增加錯誤提示的細節
            questionBox.innerHTML = `<p>錯誤：無法載入題庫。請檢查 ${selectedSubject.file} 檔案是否存在且格式正確。</p>`;
            score.textContent = '';
            document.getElementById('options-container')?.remove();
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            explanationBtn.disabled = true;
            calculateBtn.disabled = true;
            calculateBtn.style.display = "none";
        }
    }

    // initializeQuiz 函數新增一個參數 isReviewWrong เพื่อ處理錯題檢討
    function initializeQuiz(questionsToUse, isReviewWrong = false) {
      let questionsSource = JSON.parse(JSON.stringify(questionsToUse)); // 確保是獨立副本
      
      if (!isReviewWrong) { // 如果不是錯題檢討模式，才根據下拉選單決定數量
          const selectedMaxQuestions = parseInt(questionQuantitySelect.value);
          if (questionsSource.length > selectedMaxQuestions) {
              shuffleArray(questionsSource);
              questionsSource = questionsSource.slice(0, selectedMaxQuestions);
          }
      }
      // 如果是錯題檢討，則直接使用傳入的 questionsToUse (即 wrongQuestions)

      currentQuestions = questionsSource; // 設定為處理過後的題目列表
      
      currentQuestionIndex = 0;
      correctCount = 0;
      wrongCount = 0;
      scorePoints = 0;
      completedCount = 0;
      
      nextBtn.textContent = "下一題";
      nextBtn.style.display = "inline-block";
      calculateBtn.style.display = "none";
      calculateBtn.disabled = true;
      showQuestion();
    }

    function showQuestion() {
      result.style.display = 'none';
      explanationBtn.textContent = "看解析";
      updateScore();
      
      if (currentQuestions.length === 0) {
        questionBox.innerHTML = "<p>此科目沒有題目。</p>";
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        explanationBtn.disabled = true;
        calculateBtn.disabled = true;
        calculateBtn.style.display = "none";
        return;
      }

      questionBox.innerHTML = "";
      const q = currentQuestions[currentQuestionIndex];
      const questionEl = document.createElement("div");
      questionEl.innerHTML = `<strong>Q${currentQuestionIndex + 1}：</strong>${q.question}`;
      questionBox.appendChild(questionEl);

      let optionsContainer = document.createElement("div");
      optionsContainer.id = "options-container";
      questionBox.appendChild(optionsContainer);

      if (!q.shuffledOptions) {
          q.shuffledOptions = [...q.options];
          shuffleArray(q.shuffledOptions);
      }

      if (completedCount < currentQuestions.length) {
          calculateBtn.style.display = "none";
          calculateBtn.disabled = true;
      }


      q.shuffledOptions.forEach(optionText => {
        const btn = document.createElement("div");
        btn.className = "option";
        btn.textContent = optionText;
        optionsContainer.appendChild(btn);

        btn.addEventListener("click", () => {
          if (q.userAttempt.answered) return;
          
          q.userAttempt.answered = true;
          const chosenIndex = q.options.indexOf(optionText);
          q.userAttempt.choiceIndex = chosenIndex;
          q.userAttempt.wasCorrect = (chosenIndex === q.answer);

          if (!q.userAttempt.wasCorrect) {
              wrongCount++;
          } else {
              correctCount++;
              scorePoints += (100 / currentQuestions.length);
          }
          completedCount++;

          Array.from(optionsContainer.children).forEach(el => {
              el.style.pointerEvents = "none";
              const originalIndexOfEl = q.options.indexOf(el.textContent);
              if (originalIndexOfEl === q.answer) el.classList.add("correct");
              if (el === btn && !q.userAttempt.wasCorrect) {
                  el.classList.add("incorrect");
              }
          });
          
          updateScore();
          prevBtn.disabled = currentQuestionIndex === 0;

          if (completedCount === currentQuestions.length) {
            nextBtn.disabled = true;
            nextBtn.textContent = "所有題目已作答";
            calculateBtn.style.display = "inline-block";
            calculateBtn.disabled = false;
          } else {
            nextBtn.disabled = false;
            nextBtn.textContent = "下一題";
          }
        });
      });
      
      prevBtn.disabled = currentQuestionIndex === 0;
      explanationBtn.disabled = false; 
      
      if (q.userAttempt.answered) {
         Array.from(optionsContainer.children).forEach(el => {
            el.style.pointerEvents = "none";
            const originalIndexOfEl = q.options.indexOf(el.textContent);
            if (originalIndexOfEl === q.answer) el.classList.add("correct");
            
            if (originalIndexOfEl === q.userAttempt.choiceIndex && !q.userAttempt.wasCorrect) {
                 el.classList.add("incorrect");
            }
        });
        if (completedCount === currentQuestions.length) {
            nextBtn.disabled = true;
            nextBtn.textContent = "所有題目已作答";
            calculateBtn.style.display = "inline-block";
            calculateBtn.disabled = false;
        } else {
            nextBtn.disabled = false;
            nextBtn.textContent = "下一題";
        }
      } else {
          nextBtn.disabled = true;
          nextBtn.textContent = "下一題";
      }
    }
    
    function showEndQuizModal() {
        modalScoreSummary.textContent = `最終得分：${scorePoints.toFixed(2)}分 (答對 ${correctCount} 題 / 答錯 ${wrongCount} 題)`;
        endQuizModal.style.display = 'flex';
    }
    
    function toggleExplanation() {
      const q = currentQuestions[currentQuestionIndex];
      const btn = document.getElementById("explanation-btn");
      if (result.style.display === 'none') {
        const explanationText = q.explanation && q.explanation.trim() !== "" ? q.explanation : "此題沒有提供解析。";
        result.innerHTML = `解析：${explanationText}`;
        result.style.display = 'block';
        btn.textContent = '隱藏解析';
      } else {
        result.style.display = 'none';
        btn.textContent = '看解析';
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion();
      } else if (completedCount === currentQuestions.length) {
          calculateBtn.style.display = "inline-block";
          calculateBtn.disabled = false;
          nextBtn.disabled = true;
          nextBtn.textContent = "所有題目已作答";
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion();
      }
    }

    function startNewQuiz() {
      loadSubjectAndStartQuiz();
    }

    function updateScore() {
        const totalScore = parseFloat(scorePoints.toFixed(2));
        const totalQuestions = currentQuestions.length;
        score.textContent = `✔️ 答對：${correctCount} 題　❌ 答錯：${wrongCount} 題　總分：${totalScore} 分 (已完成 ${completedCount} / ${totalQuestions} 題)`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    
    // 初始設定時，只呼叫 setupSubjectSelector
    // setupEventListeners 會在 setupSubjectSelector 內部被呼叫
    setupSubjectSelector();
  </script>
</body>
</html>
