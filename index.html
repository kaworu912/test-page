<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>多科目答題系統</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 14px;
      padding: 10px;
      line-height: 1.6;
      max-width: 600px;
      margin: auto;
    }
    h2 {
      font-size: 14px;
    }
    label, select {
      font-size: 14px;
    }
    select, button {
      padding: 6px 10px;
      margin: 8px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      cursor: pointer;
      font-size: 14px;
    }
    .question-box {
      margin-top: 20px;
      font-size: 18px;
    }
    .option {
      display: block;
      margin: 8px 0;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
      cursor: pointer;
      font-size: 18px;
      user-select: none;
    }
    .option.correct {
      background-color: #e2f7e1; /* 淺綠色 */
      border-color: #c3e6cb;
    }
    .option.incorrect {
      background-color: #f8d7da;
      border-color: #f5c6cb;
    }
    #result {
      margin-top: 15px;
      font-size: 14px;
    }
    #score {
      margin-top: 5px;
      font-size: 14px;
    }
    .button-group {
      margin-top: 10px;
      display: flex; /* 使用 Flexbox */
      align-items: center;
    }
    #prev-btn {
        margin-left: 8px;
    }
    #reset-btn {
        margin-left: auto;
    }
  </style>
</head>
<body>
  <h2>答題系統（隨機50題）</h2>

  <label for="subject-select">請選擇科目：</label>
  <select id="subject-select">
    <option value="監獄行刑法">監獄行刑法</option>
    <option value="刑法">刑法</option>
    <option value="法學緒論">法學緒論</option>
    <option value="犯罪學">犯罪學</option>
    <option value="監獄學">監獄學</option>
  </select>

  <div class="question-box" id="question-box"></div>
  <div id="result"></div>
  <div id="score"></div>
  <div class="button-group">
    <button id="next-btn" onclick="nextQuestion()" disabled>下一題</button>
    <button id="prev-btn" onclick="previousQuestion()" disabled>上一題</button>
    <button id="reset-btn" onclick="resetQuiz()">重新開始</button>
  </div>

  <script>
    // [修改] 將題庫變數宣告為一個空物件，等待載入
    let questionBanks = {};
    const maxQuestions = 50;

    let currentSubject = "監獄行刑法";
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let correctCount = 0;
    let wrongCount = 0;
    let scorePoints = 0;
    let quizEnded = false;
    let completedCount = 0;

    const subjectSelect = document.getElementById("subject-select");
    const questionBox = document.getElementById("question-box");
    const result = document.getElementById("result");
    const score = document.getElementById("score");
    const nextBtn = document.getElementById("next-btn");
    const prevBtn = document.getElementById("prev-btn");
    const resetBtn = document.getElementById("reset-btn");

    // [修改] 使用異步函數 (async/await) 來載入題庫
    async function loadQuestionBank() {
        try {
            const response = await fetch('questions.json'); // 讀取外部 JSON 檔案
            if (!response.ok) {
                throw new Error('無法載入題庫檔案！');
            }
            questionBanks = await response.json();
            loadQuestions(); // 載入成功後，初始化測驗
        } catch (error) {
            console.error(error);
            questionBox.innerHTML = "<p>錯誤：無法載入題庫。請檢查 questions.json 檔案是否存在且格式正確。</p>";
        }
    }

    subjectSelect.addEventListener("change", function () {
      currentSubject = this.value;
      resetQuiz();
    });

    function loadQuestions() {
      // 深度複製並初始化題目狀態
      currentQuestions = JSON.parse(JSON.stringify(questionBanks[currentSubject])).map(q => ({
          ...q,
          userAttempt: {
              answered: false,
              choiceIndex: -1,
              wasCorrect: null,
              scoreImpact: 0
          }
      }));
      shuffleArray(currentQuestions);

      while(currentQuestions.length < maxQuestions && questionBanks[currentSubject].length > 0){
        let moreQuestions = JSON.parse(JSON.stringify(questionBanks[currentSubject])).map(q => ({
            ...q,
            userAttempt: { answered: false, choiceIndex: -1, wasCorrect: null, scoreImpact: 0 }
        }));
        shuffleArray(moreQuestions);
        currentQuestions = currentQuestions.concat(moreQuestions);
      }
      currentQuestions = currentQuestions.slice(0, maxQuestions);

      currentQuestionIndex = 0;
      correctCount = 0;
      wrongCount = 0;
      scorePoints = 0;
      completedCount = 0;
      quizEnded = false;
      
      nextBtn.textContent = "下一題";
      nextBtn.style.display = "block";
      showQuestion();
    }

    function showQuestion() {
      questionBox.innerHTML = "";
      result.textContent = "";
      updateScore();

      if (quizEnded) {
        questionBox.innerHTML = `<p>答題結束！總分：${scorePoints} 分 (每題答對得 2 分)</p>`;
        const optionsContainer = document.getElementById("options-container");
        if (optionsContainer) optionsContainer.innerHTML = '';
        result.innerHTML = '';
        nextBtn.style.display = "none";
        prevBtn.disabled = true;
        resetBtn.disabled = false;
        return;
      }

      const q = currentQuestions[currentQuestionIndex];
      const questionEl = document.createElement("div");
      questionEl.innerHTML = `<strong>Q${currentQuestionIndex + 1}：</strong>${q.question}`;
      questionBox.appendChild(questionEl);

      let optionsContainer = document.getElementById("options-container");
      if (!optionsContainer) {
        optionsContainer = document.createElement("div");
        optionsContainer.id = "options-container";
        questionBox.appendChild(optionsContainer);
      } else {
        optionsContainer.innerHTML = '';
      }

      const optionElements = [];
      const optionIndexes = [0, 1, 2, 3];
      shuffleArray(optionIndexes);

      optionIndexes.forEach(originalIndex => {
        const btn = document.createElement("div");
        btn.className = "option";
        btn.textContent = q.options[originalIndex];
        optionsContainer.appendChild(btn);
        optionElements.push(btn);

        btn.addEventListener("click", () => {
          if (q.userAttempt.answered) return;
          q.userAttempt.answered = true;
          q.userAttempt.choiceIndex = originalIndex;
          q.userAttempt.wasCorrect = (originalIndex === q.answer);
          completedCount++;
          optionElements.forEach(el => el.style.pointerEvents = "none");

          if (q.userAttempt.wasCorrect) {
            correctCount++;
            scorePoints += 2;
            updateScore();
            if (completedCount >= maxQuestions) {
                quizEnded = true;
                setTimeout(showQuestion, 300); // 短暫延遲後顯示結果
            } else {
                setTimeout(nextQuestion, 300); // 短暫延遲後跳到下一題
            }
          } else {
            wrongCount++;
            btn.classList.add("incorrect");
            optionElements.forEach(el => {
              const actualOptionIndex = q.options.indexOf(el.textContent);
              if (actualOptionIndex === q.answer) el.classList.add("correct");
            });
            result.innerHTML = `<small>解析：${q.explanation}</small>`;
            updateScore();
            nextBtn.disabled = false;
            prevBtn.disabled = currentQuestionIndex === 0;
            if (completedCount >= maxQuestions) {
                quizEnded = true;
                nextBtn.disabled = true;
            }
          }
        });
      });

      if (q.userAttempt.answered) {
        if (q.userAttempt.wasCorrect) {
            optionElements.forEach(el => {
                if (q.options.indexOf(el.textContent) === q.answer) el.classList.add("correct");
            });
        } else {
            optionElements.forEach(el => {
                const actualOptionIndex = q.options.indexOf(el.textContent);
                if (actualOptionIndex === q.userAttempt.choiceIndex) el.classList.add("incorrect");
                if (actualOptionIndex === q.answer) el.classList.add("correct");
            });
            result.innerHTML = `<small>解析：${q.explanation}</small>`;
        }
        optionElements.forEach(el => el.style.pointerEvents = "none");
        nextBtn.disabled = false;
        prevBtn.disabled = currentQuestionIndex === 0;
      } else {
        nextBtn.disabled = true;
        prevBtn.disabled = currentQuestionIndex === 0;
      }
    }

    function nextQuestion() {
      if (quizEnded) {
        alert("答題已結束，請點「重新開始」重新開始。");
        return;
      }
      if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion();
      } else {
        quizEnded = true;
        showQuestion();
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        showQuestion();
      } else {
        alert("已經是第一題了");
      }
    }

    function resetQuiz() {
      loadQuestions();
      prevBtn.disabled = true;
    }

    function updateScore() {
      score.textContent = `✔️ 答對：${correctCount} 題　❌ 答錯：${wrongCount} 題　總分：${scorePoints} 分 (已完成 ${completedCount} / ${maxQuestions} 題)`;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // [修改] 初始載入改為呼叫新的載入函式
    loadQuestionBank();
  </script>
</body>
</html>